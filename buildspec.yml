version: '0.2'

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo Installing dependencies...
      - cd portfolio
      - npm install
  pre_build:
    commands:
      - echo Logging in to AWS...
      - aws --version
      - echo Build started on `date`
      - echo Checking directory structure...
      - ls -la
      - echo Looking for package.json...
      - find . -name "package.json" -type f
  build:
    commands:
      - echo Building the application...
      - cd portfolio
      - npm run build
      - echo Build completed on `date`
  post_build:
    commands:
      - echo Deploying to S3...
      - cd portfolio
      - aws s3 sync out/ s3://$BUCKET_NAME --delete --cache-control max-age=31536000,public
      - aws s3 cp s3://$BUCKET_NAME/index.html s3://$BUCKET_NAME/index.html --metadata-directive REPLACE --cache-control max-age=0,no-cache,no-store,must-revalidate --content-type text/html
      - echo Creating CloudFront invalidation...
      - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
      - echo Deployment completed on `date`

artifacts:
  files:
    - '**/*'
  base-directory: 'portfolio/out'
